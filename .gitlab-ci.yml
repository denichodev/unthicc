# This file is a template, and might need editing before it works on your project.
# Official docker image.
image: docker:latest

services:
  - docker:dind

stages:
  - build

variables:
  TEST_TAG: $CI_COMMIT_REF_NAME

before_script:
  - apk add --no-cache py-pip
  - pip install docker-compose
  - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY

build-keys:
  stage: build
  script:
    - TAG=$TEST_TAG docker-compose -f docker-compose-prod.yml build --pull keys
    - docker push "$CI_REGISTRY_IMAGE/keys:$TEST_TAG"
  when: manual

build-nginx:
  stage: build
  script:
    - TAG=$TEST_TAG docker-compose -f docker-compose-prod.yml build --pull nginx
    - docker push "$CI_REGISTRY_IMAGE/nginx:$TEST_TAG"
  when: manual
